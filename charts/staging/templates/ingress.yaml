{{- $data := mergeOverwrite .Values .Values.staging -}}

kind: Ingress
apiVersion: extensions/v1beta1
metadata:
  name: {{ if .Values.staging.name }}{{ .Values.staging.name }}{{ else }}staging-{{ .Values.name }}{{ end }}
  namespace: {{ .Values.staging.namespace | default "staging" }}
  annotations:
    kubernetes.io/ingress.class: "nginx"
    {{- if $data.nginxConfig }}
    nginx.ingress.kubernetes.io/configuration-snippet: |
      {{- $data.nginxConfig | nindent 6 }}
    {{- end }}
spec:
  tls:
  - secretName: {{ if .Values.staging.name }}{{ .Values.staging.name }}{{ else }}staging-{{ .Values.name }}{{ end }}-tls
    hosts:
    {{- if .Values.staging.domain }}
      - {{ .Values.staging.domain }}
      {{- if $data.addWwwPrefixHost }}
      - www.{{ .Values.staging.domain }}
      {{- end }}
    {{- else }}
      - staging.{{ .Values.domain }}
      {{- if $data.addWwwPrefixHost }}
      - www.staging.{{ .Values.domain }}
      {{- end }}
    {{- end }}
  {{- range $data.extraDomains }}
  - secretName: {{ .name }}-tls
    hosts:
      {{- range $host := .hosts }}
      - {{ $host }}
      {{- end }}
  {{- end }}
  rules:
  - host: {{ if .Values.staging.domain }}{{ .Values.staging.domain }}{{ else }}staging.{{ .Values.domain }}{{end}}
    http: &http_service
      paths:
      - path: /
        backend:
          serviceName: {{ required "A valid name entry required!" $data.name }}
          servicePort: {{ $data.port | default 80 }}

  {{- if $data.addWwwPrefixHost }}
  # Alias domains
  - host: www.{{ if .Values.staging.domain }}{{ .Values.staging.domain }}{{ else }}staging.{{ .Values.domain }}{{end}}
    http: *http_service
  {{- end }}

  {{- range $data.extraDomains }}
  {{- range $host := .hosts }}
  - host: {{ $host }}
    http: *http_service
  {{- end }}
  {{- end }}
